<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>YAWATA CASINO</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
   <style>
    :root {
        --bg: #050510;
        --accent: #0ff;
        --accent2: #ff00ff;
        --panel: #0b0b1a;
        --text: #e0ffff;
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #202040 0, #050510 55%, #000 100%);
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--text);
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

       /* --- 1. ãƒ™ãƒ¼ã‚¹ã®è¨­å®šï¼ˆé·ç§»ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ï¼‰ --- */
body {
    background-color: #000;
    color: #fff;
    transition: background-color 1.2s ease, color 1.2s ease; /* 1.2ç§’ã‹ã‘ã¦å¤‰åŒ– */
}

/* --- 2. ç™½åŸºèª¿ï¼ˆã‚¯ãƒªãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰ã®è¨­å®š --- */
/* bodyã«ã“ã®ã‚¯ãƒ©ã‚¹ãŒã¤ãã¨ã€é…ä¸‹ã®è‰²ãŒã™ã¹ã¦å¼·åˆ¶ä¸Šæ›¸ãã•ã‚Œã¾ã™ */
body.clicker-mode {
    background-color: #ffffff !important;
    color: #222 !important;
}

/* ã‚¯ãƒªãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ ã‚„ãƒœã‚¿ãƒ³ã‚‚æ˜ã‚‹ãã™ã‚‹ */
body.clicker-mode .section {
    background: #f9f9f9 !important;
    color: #333 !important;
    border: 1px solid #ddd !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

body.clicker-mode button {
    background: #eee !important;
    color: #333 !important;
    border: 1px solid #ccc !important;
}

/* ã‚¯ãƒªãƒƒã‚«ãƒ¼å°‚ç”¨ã®å·¨å¤§ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
#main-button {
    background: #fff;
    border: 5px solid #eee;
    box-shadow: 0 10px 0 #ddd;
    transition: 0.1s;
}
#main-button:active {
    transform: translateY(5px);
    box-shadow: 0 5px 0 #ddd;
}

/* --- 3. ç”»é¢ãŒãƒ‘ãƒƒã¨å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆJSã§ç™ºå‹•ï¼‰ --- */
.white-flash {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: white;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s;
}

    header { padding: 25px 10px 10px; }

    h1 {
        margin: 0;
        font-size: 2.6rem;
        letter-spacing: 0.15em;
        text-shadow: 0 0 10px var(--accent), 0 0 25px var(--accent2), 0 0 40px #fff;
    }

    h1 span { display: inline-block; transform: skewX(-8deg); }

    #chipBar {
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 6px 14px;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(0, 255, 255, 0.15), rgba(255, 0, 255, 0.15));
        border: 1px solid rgba(0, 255, 255, 0.5);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        font-weight: bold;
    }

    #chips { font-size: 1.4rem; color: #fff; text-shadow: 0 0 8px var(--accent); }

    /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¿®æ­£ */
    main {
        width: 100%;
        max-width: 1200px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
    }

    /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ ç·šã‚’å¾©æ´» */
    .section {
        background: radial-gradient(circle at top left, #1a1a3a, #050510 60%);
        border-radius: 18px;
        padding: 20px;
        border: 1px solid rgba(0, 255, 255, 0.4);
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.25), 0 0 40px rgba(255, 0, 255, 0.15);
        display: flex;
        flex-direction: column;
        min-width: 320px;
        flex: 1;
    }

    /* ãƒãƒ£ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¨ªé•·ã«ç‹¬ç«‹ */
    .chat-section {
        flex: 1 1 100%;
        max-width: 1060px;
    }

    .control-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }

    input[type="number"], input[type="text"], input[type="password"] {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0, 255, 255, 0.6);
        background: rgba(0, 0, 0, 0.6);
        color: var(--text);
    }

    button {
        background: linear-gradient(135deg, #111, #222);
        color: var(--accent);
        border-radius: 999px;
        border: 1px solid rgba(0, 255, 255, 0.7);
        padding: 7px 18px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.1s;
    }

    button:hover {
        background: var(--accent);
        color: #000;
        box-shadow: 0 0 12px var(--accent);
    }

    button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .slot-frame {
        font-size: 2.4rem;
        margin: 10px 0;
        padding: 10px;
        border-radius: 14px;
        border: 1px solid rgba(0, 255, 255, 0.6);
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    .result { margin-top: 8px; min-height: 22px; font-weight: bold; }
    .win { color: #00ff9d; text-shadow: 0 0 8px #00ff9d; }
    .lose { color: #ff4d6a; text-shadow: 0 0 8px #ff4d6a; }

    #loginOverlay {
        position: fixed; inset: 0; background: var(--bg);
        display: flex; justify-content: center; align-items: center; z-index: 1000;
    }

    /* ãƒˆãƒ©ãƒ³ãƒ—ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .card-row { display: flex; justify-content: center; gap: 10px; min-height: 100px; padding: 10px; }
    .card-ui {
        display: inline-flex; justify-content: center; align-items: center;
        width: 52px; height: 72px; border-radius: 10px;
        background: #fdfdfd; color: #000; font-weight: bold; font-size: 1.2rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5), 0 0 5px var(--accent);
        border: 1px solid #ddd;
    }
    .card-ui.red { color: #c00; }
    .card-ui.back {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
        border: 2px solid #fff;
    }

    /* LINEé¢¨ãƒãƒ£ãƒƒãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    #chat-log {
        display: flex;
        flex-direction: column;
        padding: 15px;
        background: #7494c0;
        border-radius: 12px;
        overflow-y: auto;
        height: 350px;
        text-align: left;
        border: 2px solid rgba(0,0,0,0.2);
    }

    .msg-box {
        max-width: 70%;
        margin: 5px 0;
        padding: 10px 14px;
        border-radius: 18px;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
    }

    .msg-other {
        align-self: flex-start;
        background: white;
        color: black;
        border-bottom-left-radius: 4px;
    }

    .msg-me {
        align-self: flex-end;
        background: #85e085;
        color: black;
        border-bottom-right-radius: 4px;
    }

    .msg-info {
        font-size: 11px;
        color: #fff;
        margin: 8px 5px 2px;
    }
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="section" style="width:320px;">
        <h2 style="color:var(--accent);">LOGIN / SIGNUP</h2>
        <div style="margin-top:20px;">
            <input type="text" id="uName" placeholder="PLAYER NAME" style="width:100%; margin-bottom:10px;"><br>
            <input type="password" id="uPass" placeholder="PASSWORD" style="width:100%; margin-bottom:20px;"><br>
            <button onclick="login()" style="width:100%;">ACCESS SYSTEM</button>
            <p id="err" style="color:var(--accent2); font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>
</div>

<header>
    <h1><span>YAWATA</span> CASINO</h1>
    <div id="chipBar">
        STATUS: <span id="chips">0</span> CHIPS
    </div>
    <div style="margin-top:10px; font-size:0.9rem;">PLAYER: <span id="myName">-</span></div>
</header>

<main>
    <div class="section">
        <div class="section-title"><span class="label">Cyber Slot</span></div>
        <div id="gogoLamp" style="color: #222; font-weight: bold; font-size: 1.5rem;">GOGO!</div>
        <div class="slot-frame" style="display: flex; justify-content: center; gap: 10px;">
            <div id="reel0">â“</div>
            <div id="reel1">â“</div>
            <div id="reel2">â“</div>
        </div>
        <div class="control-row">
            <button id="stop0" onclick="stopReel(0)" disabled>STOP 1</button>
            <button id="stop1" onclick="stopReel(1)" disabled>STOP 2</button>
            <button id="stop2" onclick="stopReel(2)" disabled>STOP 3</button>
        </div>
        <div class="control-row">
            <input type="number" id="sBet" value="100" min="10">
            <button id="spinBtn" onclick="spin()">SPIN</button>
        </div>
        <div id="sRes" class="result"></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="label">Blackjack</span></div>
        <div id="bjDCards" class="card-row"></div>
        <div id="bjPCards" class="card-row"></div>
        <div id="bjPScore" class="result">0</div>
        <div class="control-row" id="bjInit">
            <input type="number" id="bjBet" value="100">
            <button onclick="startBJ()">DEAL</button>
        </div>
        <div class="control-row" id="bjActions" style="display:none;">
            <button onclick="socket.emit('bj_hit')">HIT</button>
            <button onclick="standBJ()">STAND</button>
        </div>
        <div id="bjRes" class="result"></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="label">High & Low</span></div>
        <div class="card-row">
            <div id="hlCurrent" class="card-ui">?</div>
            <div id="hlNext" class="card-ui back">?</div>
        </div>
        <div class="control-row" id="hlInit">
            <input type="number" id="hlBet" value="100">
            <button onclick="startHL()">DEAL</button>
        </div>
        <div class="control-row" id="hlActions" style="display:none;">
            <button onclick="guessHL('high')">HIGH</button>
            <button onclick="guessHL('low')">LOW</button>
            <button onclick="collectHL()">COLLECT</button>
        </div>
        <div id="hlRes" class="result"></div>
    </div>

    <div class="section">
    <div class="section-title"><span class="label">ATM / é—‡é‡‘çª“å£</span></div>
    <div style="font-size: 1.4rem; margin: 10px 0;">BANK: <span id="bankBalance" style="color:#fcee0a;">0</span></div>
    <div class="control-row">
        <input type="number" id="atmAmount" value="500" step="100">
    </div>
    <div class="control-row">
        <button onclick="socket.emit('atm_request', {amount: parseInt(document.getElementById('atmAmount').value), type:'deposit'})">é ã‘ã‚‹</button>
        <button onclick="socket.emit('atm_request', {amount: parseInt(document.getElementById('atmAmount').value), type:'withdraw'})" style="color:#ff4d6a;">å€Ÿã‚Šã‚‹/å‡ºã™</button>
    </div>
</div>

    <div class="section">
        <div class="section-title"><span class="label">Ranking</span></div>
        <div id="rList"></div>
    </div>

    <div id="menu-screen" class="section">
    <h2>ğŸ° é—‡ã‚«ã‚¸ãƒãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <button onclick="showGame('casino')">ã‚«ã‚¸ãƒã‚¨ãƒªã‚¢ï¼ˆã‚¹ãƒ­ãƒƒãƒˆ/BJï¼‰</button>
    <button onclick="showGame('clicker')" style="background: #fff; color: #000;">ã‚¯ãƒªãƒƒã‚«ãƒ¼ï¼ˆå‡ºç¨¼ãã‚¨ãƒªã‚¢ï¼‰</button>
</div>

<div id="clicker-area" class="section" style="display:none; max-width: 600px; margin: 10px auto;">
    <div class="section-title"><span class="label">å‡ºç¨¼ãã‚¨ãƒªã‚¢</span></div>
    
    <h2 style="color: var(--accent); margin-top: 10px;">ğŸ’° å‡ºç¨¼ãã‚¯ãƒªãƒƒã‚«ãƒ¼</h2>
    
    <div id="click-score" style="font-size: 3rem; margin: 15px 0; color: #fff; text-shadow: 0 0 10px var(--accent);">0</div>
    
    <div class="control-row">
        <button id="main-button" onclick="hitClicker()" style="width: 150px; height: 150px; border-radius: 50%; font-size: 1.5rem; background: #000; color: #fff; border: 3px solid var(--accent); cursor: pointer; box-shadow: 0 0 15px var(--accent);">
            PUSH!
        </button>
    </div>

    <br>

    <div class="control-row" style="gap: 15px;">
        <button onclick="exchangeScore()" style="background: #000; color: #fff; border: 1px solid #0ff; padding: 10px 20px;">
            ãƒãƒƒãƒ—ã¸æ›é‡‘(100:1)
        </button>
        <button onclick="showGame('menu')" style="background: #000; color: #fff; border: 1px solid #fff; padding: 10px 20px;">
            ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹
        </button>
    </div>
</div>

    <div class="section chat-section">
        <div class="section-title"><span class="label">Global Chat</span></div>
        <div id="chat-log" style="height: 300px; background: #7494c0; border-radius: 8px; overflow-y: auto; margin: 10px 0;"></div>
        <div class="control-row">
            <input type="text" id="chatInput" placeholder="MESSAGE..." style="width:75%;">
            <button onclick="sendChat()">SEND</button>
        </div>
    </div>
</main>

<div id="log" style="width:100%; padding:20px; font-size:0.8rem; color:rgba(0,255,255,0.4); border-top:1px solid rgba(0,255,255,0.1);"></div>

<script>

    const socket = io();
    let myName = ""; // â† ã“ã‚Œã‚’è¿½åŠ ï¼(ä»Šã¯ç©ºã£ã½ã ã‘ã©ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸæ™‚ã«è‡ªåˆ†ã®åå‰ãŒå…¥ã‚‹ç®±ã§ã™)

// 1. ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆHTMLã® id="chips" ã«åˆã‚ã›ã¾ã—ãŸï¼‰
function updateChips(amount) {
    const el = document.getElementById('chips');
    if (el && amount !== undefined) {
        el.textContent = amount;
    }
}

// 2. ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆHTMLã® id="uName", id="uPass" ã«åˆã‚ã›ã¾ã—ãŸï¼‰
function login() {
    const name = document.getElementById('uName').value;
    const password = document.getElementById('uPass').value;
    const err = document.getElementById('err');
    
    if(!name || !password) {
        err.textContent = "åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
    }
    socket.emit('login_request', { name: name, password: password });
}

socket.on('login_success', d => {
    myName = d.name; // â† ã“ã‚Œã‚’è¿½åŠ ï¼(ã“ã“ã§è‡ªåˆ†ã®åå‰ã‚’ã€Œç®±ã€ã«ä¿å­˜ã—ã¾ã™)
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('myName').textContent = d.name;
    document.getElementById('bankBalance').textContent = d.bank || 0;
    updateChips(d.chips);
});

socket.on('login_error', msg => {
    document.getElementById('err').textContent = msg;
});

    let score = 0;

function showGame(mode) {
    // æ¼”å‡ºç”¨ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¦ç´ ã‚’ä¸€æ™‚çš„ã«ä½œæˆ
    const flash = document.createElement('div');
    flash.className = 'sparkle-flash';
    document.body.appendChild(flash);
    
    // 0.5ç§’ã‹ã‘ã¦çœŸã£ç™½ã«å…‰ã‚‰ã›ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    flash.style.animation = "flash-anim 0.8s ease-out";

    setTimeout(() => {
        const clickerArea = document.getElementById('clicker-area');
        const menuScreen = document.getElementById('menu-screen');
        const casinoArea = document.getElementById('casino-area'); // ã‚«ã‚¸ãƒå…¨ä½“ã‚’å›²ã‚€IDãŒå¿…è¦

        if (mode === 'clicker') {
            document.body.classList.add('clicker-mode');
            if(clickerArea) clickerArea.style.display = 'block';
            if(menuScreen) menuScreen.style.display = 'none';
            if(casinoArea) casinoArea.style.display = 'none';
        } else {
            document.body.classList.remove('clicker-mode');
            if(clickerArea) clickerArea.style.display = 'none';
            if(menuScreen) menuScreen.style.display = 'block';
            if(casinoArea) casinoArea.style.display = 'none';
        }
    }, 400); // å…‰ãŒæœ€å¤§ã«ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹

    setTimeout(() => flash.remove(), 800); // çµ‚ã‚ã£ãŸã‚‰æ¶ˆã™
}
    
function hitClicker() {
    score++;
    document.getElementById('click-score').textContent = score;
    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚‚å°‘ã—ãã‚‰ãã‚‰ã•ã›ã‚‹
    createSparkles();
}

function createSparkles() {
    for(let i=0; i<15; i++) {
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.style.left = Math.random() * window.innerWidth + 'px';
        s.style.top = Math.random() * window.innerHeight + 'px';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 600);
    }
}

function exchangeScore() {
    if (score < 100) return alert("100ã‚¹ã‚³ã‚¢ä»¥ä¸Šå¿…è¦ã§ã™");
    socket.emit('exchange_request', { score });
    score = 0;
    document.getElementById('click-score').textContent = score;
}

socket.on('exchange_success', (d) => {
    alert(`æ›é‡‘æˆåŠŸï¼ ${d.addedChips} ãƒãƒƒãƒ—ç²å¾—ï¼`);
});

// 3. ãƒãƒ£ãƒƒãƒˆï¼ˆHTMLã® id="chatInput", id="log" ã«åˆã‚ã›ã¾ã—ãŸï¼‰
function sendChat() {
    const input = document.getElementById('chatInput');
    if (input.value) {
        socket.emit('chat_message', input.value);
        input.value = '';
    }
}

socket.on('broadcast', (data) => {
    const chatLog = document.getElementById('chat-log');
    const isMe = (data.userName === myName);
    
    const infoDiv = document.createElement('div');
    infoDiv.className = "msg-info";
    
    // âœ… åå‰ã®æ¨ªã« [å‚µå‹™è€…] ã‚’å‡ºã™åˆ¤å®š
    let displayName = isMe ? "ã‚ãªãŸ" : data.userName;
    if (data.isDebtor) {
        displayName += ' <span style="color:#ff4d6a; font-weight:bold; margin-left:5px;">[å‚µå‹™è€…]</span>';
    }
    infoDiv.innerHTML = displayName; // innerHTMLã‚’ä½¿ã†ã“ã¨ã§ã‚¿ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹

    const msgDiv = document.createElement('div');
    msgDiv.className = isMe ? "msg-box msg-me" : "msg-box msg-other";
    msgDiv.textContent = data.message;

    chatLog.appendChild(infoDiv);
    chatLog.appendChild(msgDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
});

let finalResult = ["ğŸ’", "ğŸ’", "7ï¸âƒ£"]; // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®çµæœã‚’æ ¼ç´
let intervals = [null, null, null];    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”¨ã‚¿ã‚¤ãƒãƒ¼
let isSpinning = [false, false, false]; // å›è»¢ãƒ•ãƒ©ã‚°

const symbols = ["ğŸ’", "ğŸ’", "7ï¸âƒ£", "ğŸ‹", "â­", "ğŸ””"];

// ã‚¹ãƒ”ãƒ³é–‹å§‹
function spin() {
    const bet = parseInt(document.getElementById('sBet').value) || 10;
    
    // UIã®ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('spinBtn').disabled = true;
    document.getElementById('sRes').textContent = "";
    document.getElementById('gogoLamp').style.color = "#222";
    document.getElementById('gogoLamp').style.textShadow = "none";

    socket.emit('spin_request', { bet: bet });
}

// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰çµæœãŒå±Šã„ãŸ
socket.on('spin_result', d => {
    finalResult = d.result; // çµæœã‚’ä¿å­˜ã—ã¦ãŠãï¼ˆã¾ã è¡¨ç¤ºã—ãªã„ï¼‰

    // 3ã¤ã®ãƒªãƒ¼ãƒ«ã‚’å›è»¢ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰ã•ã›ã‚‹
    for (let i = 0; i < 3; i++) {
        isSpinning[i] = true;
        document.getElementById(`stop${i}`).disabled = false;
        
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ¼”å‡ºé–‹å§‹
        intervals[i] = setInterval(() => {
            document.getElementById(`reel${i}`).textContent = symbols[Math.floor(Math.random() * symbols.length)];
        }, 60);
    }
    
    // å…¨ãƒªãƒ¼ãƒ«ãŒæ­¢ã¾ã£ãŸå¾Œã®å‡¦ç†ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã ã‘ä¿æŒ
    window.lastSpinData = d;
});

// å„åœæ­¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
function stopReel(idx) {
    if (!isSpinning[idx]) return;

    clearInterval(intervals[idx]); // ã‚·ãƒ£ãƒƒãƒ•ãƒ«åœæ­¢
    document.getElementById(`reel${idx}`).textContent = finalResult[idx]; // æœ¬ç‰©ã®çµæœã‚’è¡¨ç¤º
    document.getElementById(`stop${idx}`).disabled = true;
    isSpinning[idx] = false;

    // å…¨éƒ¨æ­¢ã¾ã£ãŸã‹ç¢ºèª
    if (!isSpinning.includes(true)) {
        finishSpin();
    }
}

// å…¨ãƒªãƒ¼ãƒ«åœæ­¢å¾Œã®å‡¦ç†
function finishSpin() {
    const d = window.lastSpinData;
    document.getElementById('spinBtn').disabled = false;
    updateChips(d.newChips);

    // WIN/LOSEè¡¨ç¤º
    const res = document.getElementById('sRes');
    res.textContent = d.win > 0 ? `WIN: ${d.win}æšï¼` : "LOSE";
    res.className = "result " + (d.win > 0 ? "win" : "lose");

    // 1/50ã®ãƒšã‚«ã‚Šæ¼”å‡ºï¼ˆ777ã®æ™‚ï¼‰
    if (finalResult.every(s => s === "7ï¸âƒ£")) {
        const lamp = document.getElementById('gogoLamp');
        lamp.style.color = "#ff00ff";
        lamp.style.textShadow = "0 0 10px #fff, 0 0 20px #ff00ff";
        // ãƒœãƒ¼ãƒŠã‚¹ç¢ºå®šã®SEã‚„ãƒã‚¤ãƒ–ã‚’ã“ã“ã«å…¥ã‚Œã¦ã‚‚ã„ã„ã§ã™ã­ï¼
    }
}
    
// 5. ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ï¼ˆHTMLã® id="bjDCards", id="bjPCards", id="bjPScore" ã«åˆã‚ã›ã¾ã—ãŸï¼‰
function startBJ() {
    const bet = parseInt(document.getElementById('bjBet').value) || 100;
    socket.emit('bj_start', { bet: bet });
    document.getElementById('bjInit').style.display = 'none';
    document.getElementById('bjActions').style.display = 'flex';
    document.getElementById('bjRes').textContent = "å‹è² ä¸­...";
}

function standBJ() {
    socket.emit('bj_stand');
}

socket.on('bj_update', d => {
    renderCards('bjPCards', d.player);
    renderCards('bjDCards', d.dealer);
    document.getElementById('bjPScore').textContent = d.pSum;
});

socket.on('bj_result', d => {
    renderCards('bjPCards', d.player);
    renderCards('bjDCards', d.dealer);
    const res = document.getElementById('bjRes');
    res.textContent = d.msg;
    res.className = "result " + (d.msg.includes("WIN") ? "win" : "lose");

    updateChips(d.newChips);
    document.getElementById('bjInit').style.display = 'flex';
    document.getElementById('bjActions').style.display = 'none';
});

// 6. ãƒã‚¤ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¼ï¼ˆHTMLã® id="hlCurrent", id="hlNext" ã«åˆã‚ã›ã¾ã—ãŸï¼‰
function startHL() {
    socket.emit('hl_start');
}

function guessHL(choice) {
    const bet = parseInt(document.getElementById('hlBet').value) || 100;
    socket.emit('hl_guess', { choice: choice, bet: bet });
}

function collectHL() {
    socket.emit('hl_collect');
    document.getElementById('hlInit').style.display = 'flex';
    document.getElementById('hlActions').style.display = 'none';
}

// hl_setupï¼ˆæœ€åˆã®1æšï¼‰ãŒå±Šã„ãŸæ™‚
socket.on('hl_setup', d => {
    renderCards('hlCurrent', [d.currentCard]); 
    document.getElementById('hlInit').style.display = 'none';
    document.getElementById('hlActions').style.display = 'flex';
    document.getElementById('hlRes').textContent = "HIGH or LOW?";
    
    // âœ… æœ€åˆã®1æšã®æ™‚ã¯ã‚³ãƒ¬ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’éš ã™ï¼ˆã¾ãŸã¯ç„¡åŠ¹åŒ–ï¼‰
    document.querySelector("button[onclick='collectHL()']").style.opacity = "0.3";
    document.querySelector("button[onclick='collectHL()']").disabled = true;
});

socket.on('hl_result', d => {
    // 1æšå‰ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    renderCards('hlCurrent', [d.oldCard]); 
    const res = document.getElementById('hlRes');
    res.textContent = d.msg;
    res.className = "result " + (d.msg.includes("WIN") ? "win" : "lose");
    updateChips(d.newChips);

    // âœ… ã“ã“ãŒã€Œ2ã€ã®å†…å®¹ã§ã™ï¼
    if (d.msg.includes("WIN")) {
        // å‹ã£ãŸæ™‚ã¯ã€ã‚³ãƒ¬ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã€Œç¶šè¡Œã€ã•ã›ã‚‹
        const collectBtn = document.querySelector("button[onclick='collectHL()']");
        if(collectBtn) {
            collectBtn.style.opacity = "1";
            collectBtn.disabled = false;
        }
    } else {
        // è² ã‘ãŸæ™‚ã€ã¾ãŸã¯ã‚³ãƒ¬ã‚¯ãƒˆï¼ˆå›åï¼‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã„ãŸæ™‚ã¯ã€DEALã«æˆ»ã™
        document.getElementById('hlInit').style.display = 'flex';
        document.getElementById('hlActions').style.display = 'none';
        
        // ã‚³ãƒ¬ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ï¼ˆç„¡åŠ¹ï¼‰ã«æˆ»ã™
        const collectBtn = document.querySelector("button[onclick='collectHL()']");
        if(collectBtn) {
            collectBtn.style.opacity = "0.3";
            collectBtn.disabled = true;
        }
    }
});

// 7. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆHTMLã® id="rList" ã«åˆã‚ã›ã¾ã—ãŸï¼‰
socket.on('update_ranking', list => {
    const container = document.getElementById('rList');
    if (!container) return;
    container.innerHTML = list.map((u, i) => `
        <div style="border-bottom: 1px solid rgba(0,255,255,0.1); padding: 5px 0;">
            <span style="color:var(--accent2)">${i + 1}.</span> ${u.name} 
            <span style="float:right; color:#fcee0a;">${u.chips}</span>
        </div>
    `).join('');
});

// 8. ã‚«ãƒ¼ãƒ‰æç”»ï¼ˆHTMLã® .card-ui ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ã¾ã—ãŸï¼‰
function renderCards(id, cards) {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = cards.map(c => {
        if (c.rank === '?') return `<div class="card-ui back">?</div>`;
        const isRed = c.suit === 'â™¥' || c.suit === 'â™¦';
        return `<div class="card-ui ${isRed ? 'red' : ''}">${c.rank}${c.suit}</div>`;
    }).join('');
}

socket.on('chat_history', (msgs) => {
    const chatLog = document.getElementById('chat-log');
    if (!chatLog) return;
    chatLog.innerHTML = ""; 

    msgs.forEach(data => {
        const isMe = (data.userName === myName);
        
        const infoDiv = document.createElement('div');
        infoDiv.className = "msg-info";
        
        let nameLabel = data.userName;
        if (data.isDebtor) {
            nameLabel += ' <span style="color:#ff4d6a; font-weight:bold; margin-left:5px;">[å‚µå‹™è€…]</span>';
        }
        infoDiv.innerHTML = nameLabel;

        const msgDiv = document.createElement('div');
        msgDiv.className = isMe ? "msg-box msg-me" : "msg-box msg-other";
        msgDiv.textContent = data.message || "è¡¨ç¤ºã‚¨ãƒ©ãƒ¼"; 

        chatLog.appendChild(infoDiv);
        chatLog.appendChild(msgDiv);
    });
    chatLog.scrollTop = chatLog.scrollHeight;
});
    
</script>
</body>
</html>









